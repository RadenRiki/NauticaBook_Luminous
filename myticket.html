<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Tickets</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="styles2.css" />
  <!-- Icon CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" />

  <style>
    /* Tambahkan class .hidden untuk menyembunyikan elemen */
    .hidden {
      display: none;
    }
    /* (Opsional) gaya tombol detail */
    .detail-btn {
      display: inline-block;
      margin: 8px 0;
      padding: 6px 12px;
      background-color: #0066cc;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .detail-btn:hover {
      background-color: #005bb5;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="nav__logo" onclick="window.location.href='home.php'">NauticaBook</div>
    <ul class="nav__links">
      <li class="link"><a href="home.php">Home</a></li>
      <li class="link"><a href="myticket.php">MyTickets</a></li>
      <li class="link"><a href="offers.php">Offers</a></li>
    </ul>
    <div class="profile-icon" onclick="window.location.href='profile.php'">
      <i class="ri-user-3-line"></i>
    </div>
  </nav>

  <div class="container-ticket">
    <!-- Content Area -->
    <div class="content-ticket">
      <!-- Navigation Tabs -->
      <div class="tabs-tic">
        <span class="tab-tic active">Aktif</span>
        <span class="tab-tic">Riwayat</span>
      </div>

      <!-- No Tickets Message (default state) -->
      <div class="empty-state">
        <img src="assets/pngtree-ferry-boat-vector-png-image_11244663.png" alt="Ferry Illustration" />
        <h3>Tidak ada pesanan!</h3>
        <p>Anda belum memiliki pesanan sama sekali</p>
        <div class="buttons">
          <a href="home.html" class="primary-btn">PESAN SEKARANG</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Fungsi untuk menampilkan/menyembunyikan detail tiket
    function toggleTicketDetail(buttonElement) {
      // Cari parent terdekat yang punya class "ticket-card"
      const card = buttonElement.closest('.ticket-card');
      if (!card) return;

      // Di dalam card, cari elemen dengan class "ticket-details-hidden"
      const hiddenDetails = card.querySelector('.ticket-details-hidden');
      if (!hiddenDetails) return;

      // Lakukan toggle class .hidden
      hiddenDetails.classList.toggle('hidden');

      // Ubah teks tombol (opsional)
      if (hiddenDetails.classList.contains('hidden')) {
        buttonElement.textContent = 'Lihat Detail';
      } else {
        buttonElement.textContent = 'Sembunyikan Detail';
      }
    }

    document.addEventListener("DOMContentLoaded", async function () {
      try {
        // (Opsional) Cek apakah user sudah login
        // (boleh dihilangkan kalau pakai session di server saja)
        const userData = JSON.parse(sessionStorage.getItem("user"));
        if (!userData?.id) {
          alert("Silakan login terlebih dahulu");
          window.location.href = "login.html";
          return;
        }

        // Fetch tiket berdasarkan user_id dari file tickets.php
        const response = await fetch('tickets.php');
        const tickets = await response.json();

        // Container untuk menampilkan daftar tiket
        const contentTicket = document.querySelector(".content-ticket");

        // Jika tidak ada tiket, tampilkan empty state
        if (!tickets || tickets.length === 0) {
          contentTicket.innerHTML = `
            <div class="empty-state">
              <img src="assets/pngtree-ferry-boat-vector-png-image_11244663.png" alt="Ferry Illustration">
              <h3>Tidak ada pesanan!</h3>
              <p>Anda belum memiliki pesanan sama sekali</p>
              <div class="buttons">
                <a href="home.html" class="primary-btn">PESAN SEKARANG</a>
              </div>
            </div>
          `;
          return;
        }

        // Jika ada tiket, buat HTML card per tiket
        const ticketList = tickets.map((ticket) => {
          // Format tanggal
          const formattedDate = new Date(ticket.tanggal).toLocaleDateString("id-ID");

          // (1) Data "detail_penumpang" kemungkinan JSON
          // parse agar bisa di-loop
          let penumpangHTML = "";
          if (ticket.detail_penumpang) {
            const penumpangArr = JSON.parse(ticket.detail_penumpang || "[]");
            // Buat HTML penumpang
            penumpangHTML = penumpangArr.map((p, i) => `
            <div style="margin-bottom: 10px;">
              <strong>Penumpang ke-${i+1} (${p.jenisID.toUpperCase()}):</strong><br/>
              Nama: ${p.nama}<br/>
              Nomor ID: ${p.nomorID}<br/>
              Usia: ${p.usia}<br/>
            </div>
          `).join("");
          }

          return `
            <div class="ticket-card">
              <div class="ticket-header">
                <h3>${ticket.asal} â†’ ${ticket.tujuan}</h3>
                <span class="ticket-status">Aktif</span>
              </div>

              <!-- Bagian ringkas yang selalu tampak -->
              <div class="ticket-details">
                <p>Tanggal: ${formattedDate}</p>
                <p>Jam: ${ticket.jam}</p>
                <p>Layanan: ${ticket.layanan}</p>
                <p>Tipe: ${ticket.tipe}</p>
                <p>Jumlah Penumpang: ${ticket.jumlah_penumpang}</p>

                <!-- (2) Data pemesan (kalau ada di DB) -->
                <p>Nama Pemesan: ${ticket.nama_pemesan ?? '-'}</p>
                <p>Email: ${ticket.email_pemesan ?? '-'}</p>
                <p>No. HP: ${ticket.nomor_hp ?? '-'}</p>
              </div>

              <!-- Tombol Lihat Detail -->
              <button class="detail-btn" onclick="toggleTicketDetail(this)">
                Lihat Detail
              </button>

              <!-- Bagian detail lanjutan, disembunyikan secara default -->
              <div class="ticket-details-hidden hidden">
                <!-- Tampilkan data penumpang -->
                ${penumpangHTML}

                <hr/>
                <!-- Contoh: menampilkan info kendaraan, dsb. -->
                <p>Nomor Polisi Kendaraan: ${ticket.nopol ?? '-'}</p>
                <p>(Info lainnya di sini)</p>
              </div>
            </div>
          `;
        }).join("");

        // Tampilkan ke halaman
        contentTicket.innerHTML = `
          <div class="tabs-tic">
            <span class="tab-tic active">Aktif</span>
            <span class="tab-tic">Riwayat</span>
          </div>
          <div class="tickets-container">
            ${ticketList}
          </div>
        `;
      } catch (error) {
        console.error("Error:", error);
        alert("Gagal memuat data tiket");
      }
    });
  </script>
</body>
</html>
